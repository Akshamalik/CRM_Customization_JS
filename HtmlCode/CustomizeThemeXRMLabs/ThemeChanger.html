<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Dynamic CE Theme Generator</title>
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        font-family: "Segoe UI", Arial, sans-serif;
        background: #f8f8f8;
      }
      body {
        padding: 30px;
      }
      .main-container {
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 2px 10px #001950;
        padding: 24px;
        max-width: 1050px;
        margin: 0 auto;
      }
      .main-container h2 {
        color: #001950;
        font-weight: 700;
        text-align: center;
        margin-bottom: 20px;
        letter-spacing: 1px;
      }
      .fields-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
      }
      .desc {
        font-size: 0.93em;
        color: #4b574c;
        margin-bottom: 3px;
      }
      .color-row {
        display: flex;
        align-items: center;
        background: #fafbfc;
        border-radius: 7px;
        border: 1px solid #eee;
        padding: 10px 7px;
        transition: background 0.3s;
        min-width: 300px;
      }
      .color-row:hover {
        background: #f1f6f4;
      }
      label {
        flex: 0 0 200px;
        font-size: 1.02em;
        font-weight: 500;
        color: #001950;
        white-space: nowrap;
      }
      input[type="color"] {
        width: 34px;
        height: 34px;
        border: none;
        background: none;
        margin-right: 10px;
        cursor: pointer;
      }
      .hex-value {
        font-family: "Fira Mono", "Consolas", monospace;
        background: #f4f2f5;
        color: #d21486;
        font-size: 0.97em;
        padding: 4px 8px;
        border-radius: 4px;
        min-width: 85px;
        text-align: left;
        border: 1px solid #e3e3e7;
        margin-left: 7px;
        letter-spacing: 1px;
      }
      .apply-btn {
        display: block;
        margin: 36px auto 0 auto;
        padding: 12px 26px;
        font-size: 1.08em;
        font-weight: 600;
        color: #fff;
        background: #001950;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: background 0.23s;
        letter-spacing: 0.03em;
      }
      .apply-btn:hover {
        background: #2e3480;
      }
      .status-bar {
        margin-top: 25px;
        text-align: center;
        font-family: "Segoe UI", Arial, sans-serif;
        font-size: 1em;
        color: #09641e;
      }
      .status-bar.error {
        color: #d21414;
      }
    </style>
  </head>
  <body>
    <div class="main-container">
      <h2>Dynamics CE Theme Changer</h2>
      <form id="color-form" autocomplete="off" onsubmit="return false;">
        <div class="fields-grid">
          <div>
            <div class="desc">The main color of the app's header</div>
            <div class="color-row">
              <label for="background">Header Background</label>
              <input
                type="color"
                name="background"
                id="background"
                value="#12783F"
              />
              <input
                class="hex-value"
                type="text"
                maxlength="7"
                id="hex-background"
                value="#12783F"
                oninput="onHexInput('background')"
              />
            </div>
          </div>
          <div>
            <div class="desc">The color of text/icons in the header</div>
            <div class="color-row">
              <label for="foreground">Header Text/Icon</label>
              <input
                type="color"
                name="foreground"
                id="foreground"
                value="#FFFFFF"
              />
              <input
                class="hex-value"
                type="text"
                maxlength="7"
                id="hex-foreground"
                value="#FFFFFF"
                oninput="onHexInput('foreground')"
              />
            </div>
          </div>
          <div>
            <div class="desc">
              Background color for header buttons on mouse hover
            </div>
            <div class="color-row">
              <label for="backgroundHover">Button Hover Background</label>
              <input
                type="color"
                name="backgroundHover"
                id="backgroundHover"
                value="#165A31"
              />
              <input
                class="hex-value"
                type="text"
                maxlength="7"
                id="hex-backgroundHover"
                value="#165A31"
                oninput="onHexInput('backgroundHover')"
              />
            </div>
          </div>
          <div>
            <div class="desc">
              Text/icon color of header buttons when hovered
            </div>
            <div class="color-row">
              <label for="foregroundHover">Button Hover Text/Icon</label>
              <input
                type="color"
                name="foregroundHover"
                id="foregroundHover"
                value="#FFFFFF"
              />
              <input
                class="hex-value"
                type="text"
                maxlength="7"
                id="hex-foregroundHover"
                value="#FFFFFF"
                oninput="onHexInput('foregroundHover')"
              />
            </div>
          </div>
          <div>
            <div class="desc">
              Background color of header buttons when pressed
            </div>
            <div class="color-row">
              <label for="backgroundPressed">Button Pressed Background</label>
              <input
                type="color"
                name="backgroundPressed"
                id="backgroundPressed"
                value="#0F1C12"
              />
              <input
                class="hex-value"
                type="text"
                maxlength="7"
                id="hex-backgroundPressed"
                value="#0F1C12"
                oninput="onHexInput('backgroundPressed')"
              />
            </div>
          </div>
          <div>
            <div class="desc">
              Text/icon color of header buttons when pressed
            </div>
            <div class="color-row">
              <label for="foregroundPressed">Button Pressed Text/Icon</label>
              <input
                type="color"
                name="foregroundPressed"
                id="foregroundPressed"
                value="#FFFFFF"
              />
              <input
                class="hex-value"
                type="text"
                maxlength="7"
                id="hex-foregroundPressed"
                value="#0F1C12"
                oninput="onHexInput('foregroundPressed')"
              />
            </div>
          </div>
          <div>
            <div class="desc">
              Background color for header buttons in selected/active state
            </div>
            <div class="color-row">
              <label for="backgroundSelected">Button Selected Background</label>
              <input
                type="color"
                name="backgroundSelected"
                id="backgroundSelected"
                value="#153D23"
              />
              <input
                class="hex-value"
                type="text"
                maxlength="7"
                id="hex-backgroundSelected"
                value="#0F1C12"
                oninput="onHexInput('backgroundSelected')"
              />
            </div>
          </div>
          <div>
            <div class="desc">
              Text/icon color for header buttons when selected
            </div>
            <div class="color-row">
              <label for="foregroundSelected">Button Selected Text/Icon</label>
              <input
                type="color"
                name="foregroundSelected"
                id="foregroundSelected"
                value="#FFFFFF"
              />
              <input
                class="hex-value"
                type="text"
                maxlength="7"
                id="hex-foregroundSelected"
                value="#0F1C12"
                oninput="onHexInput('foregroundSelected')"
              />
            </div>
          </div>
        </div>
        <button class="apply-btn" type="button" onclick="applyChanges()">
          Apply Changes
        </button>
      </form>
      <div id="statusbar" class="status-bar"></div>
    </div>

    <script>
      function colorToHex(color) {
        return color.toUpperCase();
      }
      function onHexInput(field) {
        const hexInput = document.getElementById("hex-" + field);
        const colorInput = document.getElementById(field);
        const hex = hexInput.value.trim();
        // Only update if valid hex
        if (/^#([0-9A-Fa-f]{6})$/.test(hex)) {
          colorInput.value = hex.toUpperCase();
          //updateHexDisplays(); // keep other sync logic clean
        }
      }
      function updateHexDisplays() {
        const fields = [
          "background",
          "foreground",
          "backgroundHover",
          "foregroundHover",
          "backgroundPressed",
          "foregroundPressed",
          "backgroundSelected",
          "foregroundSelected",
        ];
        fields.forEach(function (field) {
          const input = document.getElementById(field);
          const hexInput = document.getElementById("hex-" + field);
          if (input && hexInput) {
            hexInput.value = colorToHex(input.value);
          }
        });
      }

      window.addEventListener("DOMContentLoaded", function () {
        const colorInputs = document.querySelectorAll('input[type="color"]');
        colorInputs.forEach(function (input) {
          input.addEventListener("input", updateHexDisplays);
        });
        updateHexDisplays();
      });

      function getXrmApi() {
        return window.parent && window.parent.Xrm ? window.parent.Xrm : null;
      }

      // --- Helpers ---------------------------------------------------------------

      function sleep(ms) {
        return new Promise((r) => setTimeout(r, ms));
      }

      // Universal fetch wrapper for Dynamics API with robust error handling
      async function safeFetchJson(url, options = {}) {
        const res = await fetch(url, options);
        const text = await res.text();
        let data = {};
        try {
          data = text ? JSON.parse(text) : {};
        } catch {
          data = {};
        }

        if (!res.ok) {
          const errMsg = data?.error?.message
            ? data.error.message
            : `${res.status} ${res.statusText}`;
          throw new Error(
            `API call failure for ${url.split("/").pop()}: ${errMsg}`
          );
        }
        // expose headers if caller needs them
        data.__headers = res.headers;
        return data;
      }

      async function getWebResourceIdByName(apiUrl, name, attempts = 10) {
        for (let i = 0; i < attempts; i++) {
          const r = await safeFetchJson(
            apiUrl +
              `webresourceset?$select=webresourceid&$filter=name eq '${name}'`
          );
          if (r.value && r.value.length) return r.value[0].webresourceid;
          await sleep(400 + i * 150); // backoff
        }
        return null;
      }

      async function addWebResourceToSolution(
        apiUrl,
        componentId,
        solutionUniqueName
      ) {
        try {
          await safeFetchJson(apiUrl + "AddSolutionComponent", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Accept: "application/json",
            },
            body: JSON.stringify({
              ComponentId: componentId,
              ComponentType: 61, // Web Resource
              SolutionUniqueName: solutionUniqueName,
              AddRequiredComponents: false,
            }),
          });
        } catch (e) {
          const msg = (e?.message || "").toLowerCase();
          if (msg.includes("already") && msg.includes("solution")) return;
          throw e;
        }
      }

      // Optional: publish the single web resource so UI picks up changes immediately
      async function publishWebResource(apiUrl, webResourceId) {
        const payload = `<importexportxml><webresources><webresource>${webResourceId}</webresource></webresources></importexportxml>`;
        await safeFetchJson(apiUrl + "PublishXml", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Accept: "application/json",
          },
          body: JSON.stringify({ ParameterXml: payload }),
        });
      }

      function setStatus(msg, err) {
        const sb = document.getElementById("statusbar");
        sb.innerHTML = msg;
        sb.className = "status-bar" + (err ? " error" : "");
      }

      // --- Main ------------------------------------------------------------------

      async function applyChanges() {
        setStatus("Saving your theme to solution...", false);

        const form = document.getElementById("color-form");
        const fields = [
          "background",
          "foreground",
          "backgroundHover",
          "foregroundHover",
          "backgroundPressed",
          "foregroundPressed",
          "backgroundSelected",
          "foregroundSelected",
        ];
        const attrs = fields
          .map(
            (field) => `${field}="${colorToHex(form.elements[field].value)}"`
          )
          .join(" ");
        const xmlString = `<AppHeaderColors ${attrs}/>`;
        const XrmApi = getXrmApi();

        if (!XrmApi || !XrmApi.Utility || !XrmApi.Utility.getGlobalContext) {
          setStatus(
            "❌ Error: Open this inside Dynamics 365 (form, dashboard, or openWebResource). Xrm API not available.",
            true
          );
          return;
        }

        try {
          const apiUrl =
            XrmApi.Utility.getGlobalContext().getClientUrl() +
            "/api/data/v9.2/";

          // 1) Publisher (use all-lowercase unique name to be safe)
          const publisherUniqueName = "xrmlabs";
          let publisherId;
          let publisherPrefix = "xrm";

          let data = await safeFetchJson(
            apiUrl + `publishers?$filter=uniquename eq '${publisherUniqueName}'`
          );

          if (data.value?.length) {
            publisherId = data.value[0].publisherid;
            publisherPrefix = data.value[0].customizationprefix;
          } else {
            const pub = await safeFetchJson(apiUrl + "publishers", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Accept: "application/json",
                Prefer: "return=representation",
              },
              body: JSON.stringify({
                uniquename: publisherUniqueName,
                friendlyname: "XRMLabs",
                customizationprefix: publisherPrefix,
              }),
            });
            publisherId = pub.publisherid;
          }

          // 2) Solution
          const solutionUniqueName = "xrmlabsthemechanger";
          data = await safeFetchJson(
            apiUrl + `solutions?$filter=uniquename eq '${solutionUniqueName}'`
          );
          let solutionId;
          if (data.value?.length) {
            solutionId = data.value[0].solutionid;
          } else {
            const sol = await safeFetchJson(apiUrl + "solutions", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Accept: "application/json",
                Prefer: "return=representation",
              },
              body: JSON.stringify({
                uniquename: solutionUniqueName,
                friendlyname: "XRMLabs Theme Changer",
                description: "Web resource for theme changer",
                version: "1.0.0.0",
                ["publisherid@odata.bind"]: `/publishers(${publisherId})`,
              }),
            });
            solutionId = sol.solutionid;
          }

          // 3) Web Resource create/update
          const webResName = publisherPrefix + "_ThemeXml.xml";
          data = await safeFetchJson(
            apiUrl +
              `webresourceset?$select=webresourceid,name&$filter=name eq '${webResName}'`
          );

          const xmlBase64 = btoa(unescape(encodeURIComponent(xmlString)));
          let webResourceId;

          if (data.value?.length) {
            // Update existing
            webResourceId = data.value[0].webresourceid;
            await safeFetchJson(apiUrl + `webresourceset(${webResourceId})`, {
              method: "PATCH",
              headers: {
                "Content-Type": "application/json",
                Accept: "application/json",
                Prefer: "return=representation",
              },
              body: JSON.stringify({
                content: xmlBase64,
                description: "Generated by XRMLabs Theme Changer",
              }),
            });
          } else {
            // Create new
            const wr = await safeFetchJson(apiUrl + "webresourceset", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Accept: "application/json",
                Prefer: "return=representation",
              },
              body: JSON.stringify({
                name: webResName,
                displayname: "Theme XML",
                description: "Generated by XRMLabs Theme Changer",
                content: xmlBase64,
                webresourcetype: 4, // XML
              }),
            });

            webResourceId = wr.webresourceid;

            // Fallback in case representation wasn’t returned for some reason
            if (!webResourceId) {
              webResourceId = await getWebResourceIdByName(
                apiUrl,
                webResName,
                10
              );
            }
          }

          if (!webResourceId || webResourceId.length !== 36) {
            throw new Error(
              "Web resource creation/update succeeded but ID could not be resolved."
            );
          }

          // 4) Add to solution (idempotent)
          await addWebResourceToSolution(
            apiUrl,
            webResourceId,
            solutionUniqueName
          );
          //await publishWebResource(apiUrl, webResourceId);
          setStatus(
            `✅ Theme XML saved and added to <b>${solutionUniqueName}</b> as <b>${webResName}</b>.`,
            false
          );
          const settingName = "OverrideAppHeaderColor"; // UniqueName for the setting definition

          // 1. Find the setting definition
          let def = await safeFetchJson(
            apiUrl + `settingdefinitions?$filter=uniquename eq '${settingName}'`
          );

          if (!def.value?.length) {
            throw new Error(
              `Setting Definition '${settingName}' does not exist in your environment!`
            );
          }
          const defId = def.value[0].settingdefinitionid;

          // 2. Ensure solutionId is present
          if (!solutionId) throw new Error("No solutionId found!");

          // 3. Check if already part of solution
          let comp = await safeFetchJson(
            apiUrl +
              `solutioncomponents?$filter=objectid eq ${defId} and solutionid/solutionid eq ${solutionId}`
          );

          if (!comp.value?.length) {
            await safeFetchJson(apiUrl + "AddSolutionComponent", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Accept: "application/json",
              },
              body: JSON.stringify({
                ComponentId: defId,
                ComponentType: 10078, // <- correct component type for Setting Definition
                SolutionUniqueName: solutionUniqueName,
                AddRequiredComponents: false,
              }),
            });

            setStatus(
              `✅ Added setting definition <b>${settingName}</b> to solution <b>${solutionUniqueName}</b>.`,
              false
            );
          }
          try {
            await safeFetchJson(apiUrl + "SaveSettingValue", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Accept: "application/json",
              },
              body: JSON.stringify({
                SettingName: "OverrideAppHeaderColor",
                Value: `${webResName}`, // Must be wrapped in quotes inside the string
                SolutionUniqueName: solutionUniqueName,
              }),
            });

            setStatus(
              `✅ OverriddenValue set to <b>${webResName}</b> for setting <b>OverrideAppHeaderColor</b>.`,
              false
            );
          } catch (err) {
            setStatus(
              `❌ SaveSettingValue failed: ${err.message || err}`,
              true
            );
          }
          setStatus("⏳ Publishing customizations, please wait...", false);

          await safeFetchJson(apiUrl + "PublishAllXml", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Accept: "application/json",
            },
          });

          setStatus("✅ Theme updated and published successfully!", false);
        } catch (err) {
          setStatus("❌ Error: " + (err.message || err), true);
        }
      }
    </script>
  </body>
</html>
